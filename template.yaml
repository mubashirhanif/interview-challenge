AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  peter-part-interview-challenge
  Sample SAM Template for peter-part-interview-challenge

Resources:
  TesseractBinaryLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: ready-to-use/amazonlinux-2

  OCRApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name: Basic AWS Api Gateway
      StageName: Dev

  OCRInternalFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: main.ocr_internal_function
      Runtime: python3.12
      Timeout: 30
      MemorySize: 256
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - "textract:*"
              Resource: "*"
      Layers:
        - !Ref TesseractBinaryLayer

  OCRApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - "lambda:InvokeFunction"
              Resource: !GetAtt OCRInternalFunction.Arn
      CodeUri: src/
      Handler: main.ocr_api_function
      Runtime: python3.12
      Timeout: 30
      Environment:
        Variables:
          OCR_INTERNAL_FUNCTION_ARN: !GetAtt OCRInternalFunction.Arn
      Events:
        HelloWorldApi:
          Type: Api
          Properties:
            RestApiId: !Ref OCRApiGateway
            Path: /ocr
            Method: POST
Outputs:
  OCRApiURL:
    Description: "API Gateway endpoint URL for dev OCR Function"
    Value: !Sub "https://${OCRApiGateway}.execute-api.${AWS::Region}.amazonaws.com/Dev/ocr"
